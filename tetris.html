<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.85, maximum-scale=1.0, user-scalable=0">
    <title>经典俄罗斯方块</title>
</head>
<style type="text/css">
    *{
        padding:0;
        margin:0;
        font-family: MicroSoft YaHei;
    }
    #canvas_con{
        width:320px;
        height:480px;
        margin:0 auto;
        padding:5px;
        border:1px solid #ccc;
        background:#666;
        position: relative;
    }
    .title,.option{
        width:320px;
        margin:5px auto;
        font-size:15px;
        text-align: center;
        color:#666;
    }
    .option{
        font-size:15px;
         margin:0 auto;
    }
    #canvas{
        width:320px;
        height:480px;
        background:#888;
    }
    #scores{
        color:red;
        font-size:18px;
    }
    #pause,#reset{
        border:none;
        border-radius:5px;
        padding:5px;
        margin:5px;
        background:#39f;
        color:#fff;
        font-size: 16px;
        cursor:pointer;
    }
    #tip{
        position: absolute;
        top:0;
        right:-100px;
        border:2px solid #ddd;
        width:80px;
        height:80px;
    }
    .control button{
        border:none;
        border-radius:5px;
        padding:5px;
        width:60px;
        margin:5px;
        background:#39f;
        color:#fff;
        font-size: 16px;
        cursor:pointer;
    }
    @media only screen and (max-width: 420px){
        #tip{
            display:none;
        }
    }
</style>
<body>
    <div class="title">分数: <span id="scores"></span></div>
    <div id="canvas_con">
        <canvas id="canvas" width="320" height="480"></canvas>
        <canvas id="tip" width="80" height="80"></canvas>
    </div>
    <div class="option"><button id="reset">重置</button><button id="pause">暂停</button></div>
    <div class="option control">
        <button id="left">左</button>
        <button id="down">下</button>
        <button id="change">转</button>
        <button id="right">右</button>
    </div>
</body>
<script type="text/javascript">
(function(){
    var canvas=document.getElementById('canvas'),tipcvs=document.getElementById('tip');
    var ctx=canvas.getContext("2d"),ctxtip=tipcvs.getContext("2d");
    var scoresElement=document.getElementById('scores');
    var resetElement=document.getElementById('reset');
    var pauseElement=document.getElementById('pause');
    var leftbtn=document.getElementById('left'),downbtn=document.getElementById('down'),changebtn=document.getElementById('change'),rightbtn=document.getElementById('right');
    var mainArr,blockObj,prepareObj,blockArr,bw,bh,type,ptype,t,status,pstatus,X,Y,fillcolor,center,bottom,timeout=400,to,gameover=false,scores=0,pause=false,clash=true;

    init();

    document.onkeydown=function(){
        if(!gameover&&clash)
            clash=false;
            if(event.keyCode==37){
                if(vX(1)){
                    X--;
                    draw();
                    clash=true;
                }
            }else if(event.keyCode==39){
                if(vX(-1)){
                    X++;
                    draw();
                    clash=true;
                }
            }else if(event.keyCode==40){
                Y++;
                vY();
                draw();
                clash=true;
            }else if(event.keyCode==38||event.keyCode==32){
                change();
                clash=true;
            }
    }
    leftbtn.onclick=function(){
        if(!gameover&&clash){
            clash=false;
            if(vX(1)){
                X--;
                draw();
                clash=true;
            }
        }
    };
    rightbtn.onclick=function(){
        if(!gameover&&clash){
            clash=false;
            if(vX(-1)){
                X++;
                draw();
                clash=true;
            }
        }
    };
    downbtn.onclick=function(){
        if(!gameover&&clash){
            clash=false;
            Y++;
            vY();
            draw();
            clash=true;
        }
    };
    changebtn.onclick=function(){
        if(!gameover&&clash){
            clash=false;
            change();
            clash=true;
        }
    };
    resetElement.onclick=function(){
        clearInterval(to);
        init();
    };
    pauseElement.onclick=function(){
        if(pause){
            to=setInterval(function(){
                Y++;
                vY();
                draw();
            },timeout);
            pause=false;
            gameover=false;
            this.innerHTML="暂停";
        }else{
            clearInterval(to);
            pause=true;
            gameover=true;
            this.innerHTML="继续"
        }
    };

     function init(){
        gameover=false;
        scores=0;
        pause=false;
        clash=true;
        scoresElement.innerHTML=scores;
        pauseElement.innerHTML="暂停";
        mainArr=new Array(24);
        for(var i=0;i<24;i++){
            mainArr[i]=new Array(16);
            for(var j=0;j<16;j++){
                mainArr[i][j]=[0,"#888"];
            }
        }
        ptype=parseInt(Math.random()*6);
        pstatus=parseInt(Math.random()*4);
        prepareObj=random(ptype,pstatus);
        blockinit();
        to=setInterval(function(){
            vY();
            draw();
            Y++;
        },timeout);
     };
     function blocktip(obj){
        ctxtip.clearRect(0,0,80,80);
        var x=2-obj.w/2,y=2-obj.h/2,t=obj.t,arr=obj.block;
        blockDraw(t,arr,x,y,ctxtip);
     };
     function blockinit(){
        grid();
        type=ptype;
        status=pstatus;
        blockObj=JSON.stringify(prepareObj);
        blockObj=JSON.parse(blockObj);

        ptype=parseInt(Math.random()*6);
        pstatus=parseInt(Math.random()*4);
        prepareObj=random(ptype,pstatus);
        blocktip(prepareObj);

        blockArr=blockObj.block;
        bw=blockObj.w;
        bh=blockObj.h;
        t=blockObj.t;
        Y=-(1+bh);
        X=8-parseInt(bw/2);
    }
    function score(){
        for(var i=Y;i<Y+bh;i++){
            var v=true;
            for(var j=0;j<16;j++){
                if(mainArr[i][j][0]!=1){
                    v=false;
                }
            }
            if(v){
                scores+=16;
                scoresElement.innerHTML=scores;
                mainArr.splice(i,1);
                var arr=new Array(16);
                for(var k=0;k<16;k++){
                    arr[k]=[0,"#888"];
                }
                mainArr.unshift(arr);
            }
        }
    }
    function change(){
        status++;
        if(status==4)
            status=0;
        var wblockObj=random(type,status);
        var wblockArr=wblockObj.block;
        var wbw=wblockObj.w;
        var wbh=wblockObj.h;

        var wX=center-parseInt(wbw/2);
        if(wX+wbw>16)
            wX=16-wbw;
        else if(wX<0)
            wX=0;
        var wY=bottom-wbh;
        var v=true;

        for(var i=0;i<wblockArr.length;i++){
            for(var j=0;j<wblockArr[i].length;j++){
                if(wY+i>-1&&wX+j>-1)
                if(wblockArr[i][j]==1&&mainArr[wY+i][wX+j][0]==1){
                    v=false;
                }
            }
        }

        if(!v){
            status--;
        }else{
            blockObj=random(type,status);
            blockArr=blockObj.block;
            bw=blockObj.w;
            bh=blockObj.h;
            X=wX;
            Y=wY;
            draw();
        }
    }

    function vX(direction){
        var collision=true;
        for(var i=0;i<blockArr.length;i++){
            for(var j=0;j<blockArr[i].length;j++){
                if(blockArr[i][j]==1&&(Y+i)>-1){
                    if(mainArr[Y+i][X+j-direction]==undefined){
                        collision=false;
                    }else if(mainArr[Y+i][X+j-direction][0]==1){
                        collision=false;
                    }
                }
            }
        }
        return collision;
    }
    function vY(){
        var collision=true;
        for(var i=0;i<blockArr.length;i++){
            for(var j=0;j<blockArr[i].length;j++){
                if(blockArr[i][j]==1&&(Y+i)>-1){
                    if(Y+i+1>23||mainArr[Y+i+1][X+j][0]==1)
                        collision=false;
                }
            }
        }
        if(!collision){
            if(Y+bh-2>0){
                for(var i=0;i<blockArr.length;i++){
                    for(var j=0;j<blockArr[i].length;j++){
                        if(blockArr[i][j]==1){
                            mainArr[Y+i][X+j]=[blockArr[i][j],fillcolor];
                        }
                    }
                }
                score();
                blockinit();
            }else{
                gameover=true;
                clearTimeout(to);
                setTimeout(function(){
                    alert("GAME OVER");
                },0)
            }
        }
    }
    function draw(){
        ctx.clearRect(0,0,320,480)
        grid();
        center=X+parseInt(bw/2);
        bottom=Y+bh;
        //vY();
        mainDraw()
        blockDraw(t,blockArr,X,Y,ctx);
    }
    function blockDraw(t,arr,x,y,cvs){
        switch(t){
            case 0:
             fillcolor="red";
            break;
            case 1:
             fillcolor="rgb(255,155,30)";
            break;
            case 2:
             fillcolor="yellow";
            break;
            case 3:
             fillcolor="rgb(165,230,0)";
            break;
            case 4:
             fillcolor="rgb(0,225,255)";
            break;
            case 5:
             fillcolor="rgb(255,35,220)";
            break;
        }
        cvs.fillStyle=fillcolor;
        for(var i=0;i<arr.length;i++){
            for(var j=0;j<arr[i].length;j++){
                if(arr[i][j]==1){
                    cvs.fillRect((x+j)*20+1,(y+i)*20+1,19,19);
                }
            }
        }
    }
    function mainDraw(){
       for(var i=0;i<mainArr.length;i++){
            for(var j=0;j<mainArr[i].length;j++){
                if(mainArr[i][j][0]==1){
                    ctx.fillStyle=mainArr[i][j][1];
                    ctx.fillRect(j*20+1,i*20+1,19,19);
                }
            }
        }
    }

    function grid(){
        ctx.fillStyle='#ddd';
        for(var i=1;i<16;i++){
            ctx.fillRect(i*20,0,1,480)
        }
        for(var j=1;j<24;j++){
            ctx.fillRect(0,j*20,320,1)
        }
    }

    function random(t,s){
        var type=t;
        var arr=[];
        var status;
        if(type==0)
            arr={block:[[1,1],[1,1]],w:2,h:2,s:0,t:0};
        else if(type<4){
            status=parseInt(s)%2;
            switch(type){
                case 1:
                    switch(status){
                        case 0:
                            arr={block:[[1,1,1,1]],w:4,h:1,s:0,t:1};
                        break;
                        case 1:
                            arr={block:[[1],[1],[1],[1]],w:1,h:4,s:1,t:1};
                        break;
                    }
                break;
                case 2:
                    switch(status){
                            case 0:
                                arr={block:[[0,1,1],[1,1,0]],w:3,h:2,s:0,t:2};
                            break;
                            case 1:
                                arr={block:[[1,0],[1,1],[0,1]],w:2,h:3,s:1,t:2};
                            break;
                        }
                break;
                case 3:
                    switch(status){
                            case 0:
                                arr={block:[[1,1,0],[0,1,1]],w:3,h:2,s:0,t:3};
                            break;
                            case 1:
                                arr={block:[[0,1],[1,1],[1,0]],w:2,h:3,s:1,t:3};
                            break;
                        }
                break;
            }
        }else{
            status=parseInt(s);
            switch(type){
                case 4:
                    switch(status){
                        case 0:
                            arr={block:[[1,0,0],[1,1,1]],w:3,h:2,s:0,t:4};
                        break;
                        case 1:
                            arr={block:[[1,1],[1,0],[1,0]],w:2,h:3,s:1,t:4};
                        break;
                        case 2:
                            arr={block:[[1,1,1],[0,0,1]],w:3,h:2,s:2,t:4};
                        break;
                        case 3:
                            arr={block:[[0,1],[0,1],[1,1]],w:2,h:3,s:3,t:4};
                        break;
                    }
                break;
                case 5:
                    switch(status){
                            case 0:
                                arr={block:[[0,0,1],[1,1,1]],w:3,h:2,s:0,t:5};
                            break;
                            case 1:
                                arr={block:[[1,0],[1,0],[1,1]],w:2,h:3,s:1,t:5};
                            break;
                            case 2:
                                arr={block:[[1,1,1],[1,0,0]],w:3,h:2,s:2,t:5};
                            break;
                            case 3:
                                arr={block:[[1,1],[0,1],[0,1]],w:2,h:3,s:3,t:5};
                            break;
                        }
                break;
            }
        }
        return arr;
    }
})()
</script>
</html>
